name: Deploy StorageApp Backend

on: [push, workflow_dispatch]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    env:
      SSH_HOST: 13.126.121.218
      SSH_USER: ubuntu
      REMOTE_APP_DIR: /home/ubuntu/backend-storage-app
      PM2_APP_NAME: storageApp

    steps:
      # 1. Setup SSH key and known_hosts
      - name: Setup SSH
        run: |
          set -e  # Exit on any error
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null

      # 2. Deploy to remote server
      - name: Deploy backend on EC2
        run: |
          set -e  # Exit if SSH fails
          ssh "${SSH_USER}@${SSH_HOST}" 'bash -s' << 'EOF'
            set -e  # Exit on any remote command failure
            
            echo "ðŸš€ Starting backend deployment..."
            
            # Use environment variable instead of hardcoded path
            cd "$REMOTE_APP_DIR"
            
            # Clean old logs (silent if fails)
            echo "ðŸ§¹ Cleaning logs..."
            pm2 flush "$PM2_APP_NAME" >/dev/null 2>&1 || true
            
            # Update code with branch specification
            echo "ðŸ“¥ Pulling code..."
            git pull
            
            # Install deps with correct flags and quiet mode
            echo "ðŸ“¦ Installing backend dependencies..."
            npm ci --no-audit --no-fund --silent
            
            # Restart app with update-env flag
            echo "ðŸ”„ Reloading app..."
            pm2 reload "$PM2_APP_NAME" --update-env
            
            # Show status with minimal output
            echo ""
            echo "âœ… Deployment complete at \$(date)"
            echo "ðŸ“Š Current status:"
            pm2 list "$PM2_APP_NAME" --silent || pm2 list
            
            # Show recent logs (cleaner output)
            echo ""
            echo "ðŸ“ Recent application logs:"
            pm2 logs "$PM2_APP_NAME" --lines 3 --nostream --raw 2>/dev/null || echo "No recent logs available"
          EOF
