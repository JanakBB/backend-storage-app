name: Deploy StorageApp Backend

on: [push, workflow_dispatch]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    env:
      SSH_HOST: 13.126.121.218
      SSH_USER: ubuntu
      REMOTE_APP_DIR: /home/ubuntu/backend-storage-app
      PM2_APP_NAME: storageApp

    steps:
      # 1. Setup SSH key and known_hosts
      - name: Setup SSH
        run: |
          set -e  # Exit on any error
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null

      # 2. Deploy to remote server
      - name: Deploy backend on EC2
        run: |
          ssh "${SSH_USER}@${SSH_HOST}" 'bash -s' << 'EOF'
            set -e
            
            echo "ðŸš€ Starting backend deployment..."
            
            # First go to home directory to ensure we're in right place
            cd ~
            echo "ðŸ“ Home directory: $(pwd)"
            
            # Change to app directory
            cd backend-storage-app
            echo "ðŸ“ App directory: $(pwd)"
            
            # Verify we're in the right place
            if [ ! -f "package.json" ]; then
              echo "âŒ ERROR: package.json not found! Wrong directory."
              echo "Files in current directory:"
              ls -la
              exit 1
            fi
            
            echo "âœ… Found package.json - correct directory"
            
            # Clean old logs
            echo "ðŸ§¹ Cleaning logs..."
            pm2 flush storageApp 2>/dev/null || true
            
            # Update code - use simple git pull
            echo "ðŸ“¥ Pulling code..."
            git pull
            
            # Install dependencies
            echo "ðŸ“¦ Installing backend dependencies..."
            npm ci --no-audit --no-fund
            
            # Restart app
            echo "ðŸ”„ Reloading app..."
            pm2 reload storageApp
            
            # Show status
            echo ""
            echo "âœ… Deployment complete!"
            echo "ðŸ“Š Status:"
            pm2 list storageApp
            
            echo ""
            echo "ðŸ“ Recent logs:"
            pm2 logs storageApp --lines 5 --nostream 2>/dev/null || echo "No logs yet"
          EOF
